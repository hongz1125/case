<section id="app">
    {{> head}} {{> left}}
    <section class="ux_body">
        <el-breadcrumb separator="/">
            <el-breadcrumb-item :to="{ path: '/' }">首页</el-breadcrumb-item>
            <el-breadcrumb-item>项目列表</el-breadcrumb-item>
            <el-breadcrumb-item>新增项目</el-breadcrumb-item>
        </el-breadcrumb>
        <el-form ref="form" :model="form" label-width="160px" style="width:600px">
            <el-form-item label="活动中文名">
                <el-input v-model="form.cn_name"></el-input>
            </el-form-item>
            <el-form-item label="活动英文名">
                <el-input v-model="form.en_name"></el-input>
            </el-form-item>
            <el-form-item label="客户">
                <el-input v-model="form.en_name"></el-input>
            </el-form-item>
            <el-form-item label="分类">
              <el-autocomplete v-model="tag_keyword" :fetch-suggestions="on_search_tag" :trigger-on-focus="false" placeholder="添加标签" @select="on_select_tag"></el-autocomplete>
              <div>
                  <el-tag v-for="tag in form.tag_list" :key="tag.id" :closable="true" type="gray" @close="on_colse_tag(tag)">
                      \{{tag.value}}
                  </el-tag>
              </div>
            </el-form-item>
            <el-form-item label="活动时间">
                <el-date-picker v-model="form.time" type="daterange" placeholder="选择日期范围">
                </el-date-picker>
            </el-form-item>
            <el-form-item label="城市">
                <el-input v-model="form.city"></el-input>
            </el-form-item>
            <el-form-item label="图片上传">
              <el-upload
                class="upload-demo"
                action="/api/upload"
                :on-preview="on_pic_show"
                :on-remove="on_pic_remove"
                :file-list="list_pic"
                list-type="picture">
                <el-button size="small" type="primary">点击上传</el-button>
                <div slot="tip" class="el-upload__tip">只能上传jpg/png文件，且不超过500kb;<br />请上传 大于或等于 4张大图；大小为613px * 413px</div>
              </el-upload>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" @click="on_save">保存</el-button>
                <el-button>取消</el-button>
            </el-form-item>
        </el-form>
    </section>
    <section>
        <el-form ref="form" :model="form" label-width="160px" style="width:600px">
            <el-form-item label="11">
                <el-input v-model="form.cn_name"></el-input>
            </el-form-item>
            <el-autocomplete v-model="tag_keyword" :fetch-suggestions="on_search_tag" :trigger-on-focus="false" placeholder="添加标签" @select="on_select_tag"></el-autocomplete>
            <div>
              <el-tag v-for="tag in form.tag_list" :key="tag.id" :closable="true" type="gray" @close="on_colse_tag(tag)">
                  \{{tag.value}}
              </el-tag>
            </div>
            <el-button type="primary" @click="on_save">保存表单</el-button>
        </el-form>
    </section>
</section>
<script>
new Vue({
    el: '#app',
    data: {
        form: {
            id:'',
            en_name:'',
            cn_name:'',
            custom:'',
            city:'',
            pic:'',
            tag_list:[],
        },
        dialogImageUrl: '',
        list_pic: [{
            name: 111,
            url: '/static/upload/20170912_142921.jpg'
        }, {
            name: 111,
            url: '/static/upload/20170912_142921.jpg'
        }, {
            name: 111,
            url: '/static/upload/20170912_142921.jpg'
        }, {
            name: 111,
            url: '/static/upload/20170912_142921.jpg'
        }, ],
        tag_keyword: '',
        loading_tag: false,
        dialogVisible: false
    },
    methods: {
        get_id(){
            this.form.id = $.getUrlParam('id');
            if(!this.form.id) return;
            this.get_detail();
        },
        get_detail(){
            do_ajax({
                url: '/api/case/detail',
                data: {
                    id:this.form.id
                }
            }).then(res => {
                let data = res.data;
                this.form.en_name = data.en_name;
                this.form.cn_name = data.cn_name;
                this.form.custom = data.custom;
                this.form.city = data.city;
                this.form.tag_list = data.tag_list || [];
                this.form.pic = data.pic;
            }).catch(msg => {
                this.$message.error(msg);
            })
        },
        on_save() {
            let data = {};
            data.id = this.form.id;
            data.en_name = this.form.en_name;
            data.cn_name = this.form.cn_name;
            data.custom = this.form.custom;
            data.city = this.form.city;
            data.tag_list = JSON.stringify(this.form.tag_list);
            data.pic = this.form.pic;
            do_ajax({
                url: '/api/case/save',
                data: data
            }).then(res => {
                console.log(res);
            }).catch(msg => {
                this.$message.error(msg);
            })
        },
        on_colse_tag(item) {
            this.form.tag_list = this.form.tag_list.filter(o => {
                return o.id != item.id
            });
        },
        on_select_tag(item) {
            let index = this.form.tag_list.find(o => {
                return o.id == item.id
            });
            if (index === undefined) {
                this.form.tag_list.push(item);
            }
        },
        on_search_tag(queryString, cb) {
            this.loading_tag = true;
            do_ajax({
                url: '/api/tag/list',
                data: {
                    keyword: queryString,
                }
            }).then(res => {
                cb(res.data.list);
                this.loading_tag = false;
            }).catch(msg => {
                this.$message.error(msg);
            })
        },
        on_pic_remove(file, fileList) {
            console.log(file, fileList);
        },
        on_pic_show(file) {
            this.dialogImageUrl = file.url;
            this.dialogVisible = true;
        }
    },
    mounted: function() {
        this.get_id();
    }
})
</script>
